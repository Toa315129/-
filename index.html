<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SENA 125TH | PHOTOBOOTH</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Playfair+Display:wght@400;700;900&family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0a0a0a;
            --gold-main: #D4AF37;
            --gold-light: #F3E5AB;
            --text-main: #E0E0E0;
            --font-ui: 'DM Sans', sans-serif;
            --font-head: 'Playfair Display', serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body { margin: 0; background: var(--bg-color); height: 100dvh; overflow: hidden; color: var(--text-main); font-family: var(--font-ui); display: flex; justify-content: center; }

        /* Screens */
        #monitor { width: 100%; height: 100%; position: relative; background: #000; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; opacity: 0; pointer-events: none; transition: 0.5s; z-index: 10; background: #000; }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* Home */
        #screen-home { justify-content: center; align-items: center; text-align: center; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%); }
        .main-title { font-family: var(--font-head); font-size: 3rem; color: var(--gold-main); margin-bottom: 10px; line-height: 1.1; text-transform: uppercase; letter-spacing: 2px;}
        .sub-title { font-family: 'Prompt', sans-serif; color: #888; margin-bottom: 40px; letter-spacing: 1px;}
        
        .btn-start { 
            border: 1px solid var(--gold-main); background: rgba(212, 175, 55, 0.1); 
            color: var(--gold-main); padding: 18px 60px; font-size: 1.2rem; cursor: pointer; 
            transition: 0.3s; margin-top: 20px; letter-spacing: 3px; font-family: var(--font-head); font-weight: 700;
        }
        .btn-start:active { background: var(--gold-main); color: #000; transform: scale(0.95); }

        /* Camera */
        #screen-cam { background: #000; }
        .viewport { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        /* วิดีโอเต็มจอ */
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        /* Grid Guide แบบบางๆ เพื่อเล็งตำแหน่ง */
        .grid-guide {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 60%; border: 1px solid rgba(255,255,255,0.3);
            pointer-events: none;
            display: flex; flex-direction: column;
        }
        .grid-row { flex: 1; border-bottom: 1px solid rgba(255,255,255,0.3); }
        .grid-row:last-child { border-bottom: none; }

        #countdown { position: absolute; font-size: 12rem; color: var(--gold-light); font-family: var(--font-head); text-shadow: 0 5px 30px rgba(0,0,0,0.8); display: none; z-index: 50; }
        
        .cam-controls { height: 140px; display: flex; align-items: center; justify-content: center; background: #111; z-index: 20; border-top: 1px solid #222; }
        .btn-shutter { width: 80px; height: 80px; background: transparent; border-radius: 50%; border: 4px solid #fff; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-shutter-inner { width: 70px; height: 70px; background: #fff; border-radius: 50%; transition: 0.2s; }
        .btn-shutter:active .btn-shutter-inner { transform: scale(0.85); background: var(--gold-main); }
        
        /* Result */
        #screen-result { flex-direction: row; justify-content: center; align-items: center; gap: 4vw; background: #080808; padding: 20px; }
        
        .preview-area { 
            height: 85vh; 
            aspect-ratio: 600/1800; /* สัดส่วน Photo Strip ยาวๆ */
            background: #222;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            border: 1px solid #333;
        }
        .preview-area img { width: 100%; height: 100%; object-fit: contain; display: block; }
        
        .result-ui { width: 300px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .btn-action { width: 100%; padding: 16px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; font-family: var(--font-ui); }
        .btn-pri { background: var(--gold-main); color: #000; }
        .btn-sec { background: transparent; border: 1px solid #444; color: #888; }
        .btn-sec:hover { border-color: #fff; color: #fff; }

        /* QR Code */
        .qr-wrapper {
            background: #fff; padding: 15px 15px 10px 15px; border-radius: 4px; margin-top: 20px;
            text-align: center; width: 100%;
        }
        .qr-code-box { display: flex; justify-content: center; margin-bottom: 10px; }
        .qr-text { color: #000; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;}

        /* Upload Link */
        .upload-link { position: absolute; bottom: 20px; font-size: 0.7rem; color: #444; text-decoration: underline; cursor: pointer; }

        #flash { position: fixed; inset: 0; background: #fff; opacity: 0; pointer-events: none; z-index: 100; }
        .flash-anim { animation: flash 0.3s ease-out; }
        @keyframes flash { 0% { opacity: 1; } 100% { opacity: 0; } }

        @media (max-width: 900px) {
            #screen-result { flex-direction: column; overflow-y: auto; justify-content: flex-start; padding-top: 40px; }
            .preview-area { height: 60vh; flex-shrink: 0; margin-bottom: 20px;}
            .result-ui { width: 100%; max-width: 350px; padding-bottom: 50px; }
        }
    </style>
</head>
<body>

    <input type="file" id="frame-upload" hidden accept="image/*" onchange="App.loadFrame(this)">

    <div id="monitor">
        
        <div id="screen-home" class="screen active">
            <h1 class="main-title">SENA 125TH<br>FINAL ORIENTATION</h1>
            <div class="sub-title">5 FEBRUARY 2026</div>
            <button class="btn-start" onclick="App.start()">START</button>
            <div class="upload-link" onclick="document.getElementById('frame-upload').click()">
                (หากไม่พบไฟล์ frame.png คลิกที่นี่เพื่อเลือกรูป)
            </div>
        </div>

        <div id="screen-cam" class="screen">
            <div class="viewport">
                <video id="vid" autoplay playsinline muted></video>
                <div class="grid-guide">
                    <div class="grid-row"></div>
                    <div class="grid-row"></div>
                    <div class="grid-row"></div>
                </div>
                <div id="countdown">3</div>
            </div>
            <div class="cam-controls">
                <div class="btn-shutter" onclick="App.snap()">
                    <div class="btn-shutter-inner"></div>
                </div>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <div class="preview-area">
                <img id="final-img">
            </div>
            
            <div class="result-ui">
                <h3 style="color:var(--gold-main); font-family:var(--font-head); margin:0; letter-spacing: 1px;">COMPLETED</h3>
                
                <div class="qr-wrapper">
                    <div id="qrcode" class="qr-code-box"></div>
                    <div class="qr-text">SCAN TO DOWNLOAD</div>
                </div>

                <button class="btn-action btn-pri" onclick="App.download()">DOWNLOAD IMAGE</button>
                <button class="btn-action btn-sec" onclick="location.reload()">HOME</button>
            </div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="c" style="display:none"></canvas>

    <script>
        const App = (() => {
            
            // --- CONFIGURATION ---
            // ตั้งค่าพิกัดให้ตรงกับรูป SENA 125TH (อิงความกว้าง 600px)
            const CONFIG = {
                width: 600,  // ความกว้างมาตรฐาน
                height: 1800, // ความสูงมาตรฐาน (สัดส่วน 1:3)
                
                // พิกัดช่องว่าง (สำหรับวางรูปรอไว้ด้านหลัง)
                // [x, y, w, h]
                // ปรับตำแหน่ง Y ลงมาเพื่อให้พ้น Header ด้านบนที่มีโลโก้
                slots: [
                    { x: 40, y: 400, w: 520, h: 390 },  // ช่องบน (เริ่มที่ y=400)
                    { x: 40, y: 830, w: 520, h: 390 },  // ช่องกลาง (ห่างกันประมาณ 40px)
                    { x: 40, y: 1260, w: 520, h: 390 }  // ช่องล่าง
                ]
            };

            const s = { stream: null, photos: [], frame: null };
            const D = {
                screens: document.querySelectorAll('.screen'),
                vid: document.getElementById('vid'),
                canvas: document.getElementById('c'),
                final: document.getElementById('final-img'),
                count: document.getElementById('countdown'),
                flash: document.getElementById('flash'),
                qr: document.getElementById('qrcode')
            };

            // Init Frame
            const img = new Image();
            img.crossOrigin = "Anonymous";
            img.src = 'frame.png';
            img.onload = () => s.frame = img;
            img.onerror = () => console.log('Frame not found in folder');

            function show(id) {
                D.screens.forEach(sc => sc.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            }

            async function start() {
                if(!s.frame) alert("⚠️ Warning: ไม่พบไฟล์ 'frame.png'\nโปรดตรวจสอบว่าไฟล์อยู่ในโฟลเดอร์เดียวกัน หรือกดลิงก์ด้านล่างเพื่อเลือกรูปเอง");
                try {
                    s.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: {ideal:1280}, height: {ideal:720} } 
                    });
                    D.vid.srcObject = s.stream;
                    show('screen-cam');
                } catch(e) { alert("Camera Error: " + e.message); }
            }

            async function snap() {
                s.photos = [];
                for(let i=0; i<3; i++) {
                    await runCount(3);
                    D.flash.classList.add('flash-anim');
                    setTimeout(() => D.flash.classList.remove('flash-anim'), 300);

                    // Capture Logic (4:3 Ratio)
                    const cvs = document.createElement('canvas');
                    const ctx = cvs.getContext('2d');
                    
                    const vw = D.vid.videoWidth, vh = D.vid.videoHeight;
                    const slotRatio = 4/3; 
                    
                    let cw = vw, ch = vw / slotRatio;
                    if(ch > vh) { ch = vh; cw = ch * slotRatio; }
                    
                    cvs.width = cw; cvs.height = ch;
                    ctx.translate(cw, 0); ctx.scale(-1, 1); // Flip
                    ctx.drawImage(D.vid, (vw-cw)/2, (vh-ch)/2, cw, ch, 0, 0, cw, ch);
                    
                    s.photos.push(cvs);
                    await new Promise(r => setTimeout(r, 600)); 
                }
                process();
            }

            function runCount(n) {
                return new Promise(r => {
                    let c = n; D.count.style.display = 'block'; D.count.innerText = c;
                    const t = setInterval(() => {
                        c--;
                        if(c>0) D.count.innerText = c;
                        else { clearInterval(t); D.count.style.display='none'; r(); }
                    }, 1000);
                });
            }

            function process() {
                // Setup Canvas
                const W = CONFIG.width;
                // ถ้ามีเฟรม ให้ใช้สัดส่วนเฟรมจริง ถ้าไม่มีให้ใช้ค่า Default
                const H = s.frame ? (s.frame.height / s.frame.width) * W : CONFIG.height;
                
                D.canvas.width = W; D.canvas.height = H;
                const ctx = D.canvas.getContext('2d');
                
                // 1. Fill Background
                ctx.fillStyle = "#111"; ctx.fillRect(0,0,W,H);

                // 2. Draw Photos (Underneath)
                // เราต้อง Map รูปถ่ายใส่ลงไปใน Slot ที่กำหนดไว้
                // ถ้าสัดส่วนเฟรมจริงต่างจาก Config เราต้อง Scale ตำแหน่ง Y ด้วย
                const scaleY = H / CONFIG.height; // เผื่อเฟรมยาวกว่าปกติ
                
                CONFIG.slots.forEach((slot, i) => {
                    if(s.photos[i]) {
                        // ปรับตำแหน่ง Y ตามสัดส่วนจริงของภาพถ้าจำเป็น
                        // หรือใช้ค่าตรงๆ ถ้าเฟรมตรงเป๊ะ
                        const targetY = s.frame ? (slot.y / CONFIG.height) * H : slot.y;
                        const targetH = s.frame ? (slot.h / CONFIG.height) * H : slot.h;
                        
                        ctx.drawImage(s.photos[i], slot.x, targetY, slot.w, targetH);
                    }
                });

                // 3. Draw Frame (Overlay) - ต้องเป็น PNG เจาะรู
                if(s.frame) ctx.drawImage(s.frame, 0, 0, W, H);

                // Finalize
                D.final.src = D.canvas.toDataURL('image/jpeg', 0.95);
                
                // Generate QR
                D.qr.innerHTML = "";
                new QRCode(D.qr, {
                    text: "https://www.sena.co.th", // เปลี่ยนเป็น Link จริงของคุณ
                    width: 90, height: 90,
                    colorDark : "#000000", colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.L
                });

                show('screen-result');
                confetti({ particleCount: 150, spread: 70, colors: ['#D4AF37', '#FFF'] });
            }

            function download() {
                const a = document.createElement('a');
                a.href = D.final.src;
                a.download = `SENA_${Date.now()}.jpg`;
                a.click();
            }

            function loadFrame(input) {
                if(input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = e => {
                        const i = new Image();
                        i.onload = () => { s.frame = i; alert("Custom Frame Loaded!"); };
                        i.src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }

            return { start, snap, download, loadFrame };
        })();
    </script>
</body>
</html>
