<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SENA Photobooth — 4x6</title>
<style>
  :root{
    --bg:#0b0b0b; --red:#c21313; --white:#ffffff;
  }
  *{box-sizing:border-box;font-family: "Helvetica Neue", Arial, sans-serif}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--white);display:flex;align-items:center;justify-content:center}
  .app{width:100%;max-width:1100px;padding:20px}
  .screen{display:none}
  .screen.active{display:block}
  /* Landing */
  .landing{display:flex;flex-direction:column;align-items:center;gap:18px}
  .logo{font-size:44px;font-weight:800;letter-spacing:2px}
  .logo .star{color:var(--red);margin-left:6px}
  .big-btn{background:var(--red);border:none;color:white;padding:16px 36px;border-radius:36px;font-size:20px;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.5)}
  .hint{opacity:0.9}
  /* Booth layout */
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:10px}
  .toolbar{display:flex;gap:8px;align-items:center}
  select,button,input{font-size:16px}
  .booth-main{display:flex;gap:18px}
  .left{flex:2}
  .right{flex:1;max-width:320px}
  .stage{position:relative;background:#000;border-radius:12px;min-height:480px;overflow:hidden;display:flex;align-items:center;justify-content:center}
  video{width:100%;height:100%;object-fit:cover;display:block}
  .overlay-svg{position:absolute;inset:0;pointer-events:none}
  .countdown{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:120px;font-weight:900;color:var(--white);text-shadow:0 4px 14px rgba(0,0,0,0.7);display:none;z-index:40}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;justify-content:center}
  .control-btn{padding:10px 14px;border-radius:12px;border:none;background:var(--red);color:white;cursor:pointer;font-size:16px}
  .frame-list{display:flex;flex-wrap:wrap;gap:8px;padding:8px;background:#0f0f0f;border-radius:8px}
  .frame-thumb{width:72px;height:72px;border-radius:10px;background:#222;display:flex;align-items:center;justify-content:center;cursor:pointer;border:3px solid transparent}
  .frame-thumb.selected{border-color:var(--red)}
  .strip-preview{margin-top:12px}
  .note{font-size:13px;color:#ddd;margin-top:8px}
  /* modal preview */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:200}
  .modal.hidden{display:none}
  .modal-card{background:white;color:#000;padding:18px;border-radius:10px;max-width:90%;max-height:90%;overflow:auto;text-align:center}
  .modal-card img{max-width:100%;height:auto;border-radius:6px}
  /* responsive */
  @media(max-width:900px){
    .booth-main{flex-direction:column}
    .right{max-width:100%}
    .countdown{font-size:96px}
  }
</style>
</head>
<body>
<div class="app">
  <!-- Landing -->
  <section id="landing" class="screen active landing">
    <div class="logo">SENA <span class="star">✦</span> PHOTOBOOTH</div>
    <button id="startBtn" class="big-btn">เริ่มต้น</button>
    <div class="hint">รองรับจอทัช — ถ้ากล้องไม่ขึ้น ให้เปิดผ่าน HTTPS หรือรันบน localhost</div>
  </section>

  <!-- Booth -->
  <section id="booth" class="screen">
    <div class="topbar">
      <div class="toolbar">
        <label>นับถอยหลัง
          <select id="timerSel">
            <option value="3">3 วินาที</option>
            <option value="5">5 วินาที</option>
            <option value="10">10 วินาที</option>
          </select>
        </label>

        <label>ฟิลเตอร์
          <select id="filterSel">
            <option value="none">ไม่มี</option>
            <option value="grayscale">ขาว-ดำ</option>
            <option value="sepia">sepia</option>
          </select>
        </label>

        <label>จำนวนในสกริป
          <select id="copiesSel">
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="6">6</option>
          </select>
        </label>
      </div>

      <div>
        <button id="backBtn" class="control-btn" style="background:#333">กลับ</button>
      </div>
    </div>

    <div class="booth-main">
      <div class="left">
        <div class="stage" id="stage">
          <video id="video" playsinline autoplay muted></video>
          <!-- SVG overlay styled to match your design: rounded black border + red star elements -->
          <svg class="overlay-svg" viewBox="0 0 1000 1500" preserveAspectRatio="xMidYMid slice" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <!-- large rounded black panel at bottom (logo area) -->
            <rect x="40" y="1150" width="920" height="300" rx="10" fill="#000" />
            <!-- white logo area in center top of panel -->
            <text x="500" y="1270" text-anchor="middle" font-size="80" fill="#fff" font-family="Arial" font-weight="800">SENA</text>
            <text x="600" y="1270" text-anchor="middle" font-size="80" fill="#c00" font-family="Arial" font-weight="800">✦</text>
            <text x="500" y="1350" text-anchor="middle" font-size="48" fill="#fff" font-family="Arial">PHOTOBOOTH</text>
            <!-- decorative red stars -->
            <g fill="#c00">
              <polygon points="150,300 160,330 190,330 165,350 175,380 150,360 125,380 135,350 110,330 140,330"/>
              <polygon points="850,600 860,650 900,650 870,675 885,720 850,690 815,720 830,675 800,650 840,650"/>
              <polygon points="880,1250 900,1290 940,1290 905,1310 920,1350 880,1330 840,1350 855,1310 820,1290 860,1290"/>
            </g>
            <!-- outer rounded frame stroke -->
            <rect x="35" y="35" width="930" height="1430" rx="28" fill="none" stroke="#111" stroke-width="70"/>
            <!-- inner red frame border (thin) -->
            <rect x="60" y="60" width="880" height="1380" rx="18" fill="none" stroke="#c21313" stroke-width="24" opacity="0.95"/>
          </svg>

          <div id="countdown" class="countdown" style="display:none">3</div>
        </div>

        <div class="controls">
          <button id="captureBtn" class="control-btn">ถ่าย</button>
          <button id="retakeBtn" class="control-btn" style="background:#444">ถ่ายใหม่</button>
          <button id="downloadBtn" class="control-btn">ดาวน์โหลด 4×6</button>
          <button id="stripBtn" class="control-btn">ดาวน์โหลดสกริป</button>
          <button id="printBtn" class="control-btn" style="background:#444">พิมพ์</button>
        </div>

        <div class="note">ไฟล์ดาวน์โหลดแต่ละภาพเป็น PNG ขนาด <strong>1200×1800 px</strong> (4×6 นิ้ว @300 DPI)</div>
      </div>

      <aside class="right">
        <h3>กรอบตัวอย่าง</h3>
        <div class="frame-list" id="frameList" aria-hidden="false"></div>

        <div class="strip-preview">
          <h4>ตัวอย่างสกริป (แนวตั้ง)</h4>
          <div style="background:#111;padding:10px;border-radius:8px">
            <div style="width:160px;height:240px;background:#222;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999">4×6</div>
          </div>
        </div>
      </aside>
    </div>
  </section>
</div>

<!-- modal preview for quick check -->
<div id="previewModal" class="modal hidden" style="z-index:300">
  <div class="modal-card">
    <h3>ตัวอย่างภาพ</h3>
    <img id="previewImg" src="" alt="preview">
    <div style="margin-top:10px">
      <button id="closePreview" class="control-btn">ปิด</button>
    </div>
  </div>
</div>

<script>
/* Photobooth single-file app
 - exports single photo at 1200x1800 px (4x6 @300dpi)
 - can assemble N copies into a vertical strip and download
 - basic frames (vector overlay applied visually via SVG overlay already in DOM)
 - filters: none, grayscale, sepia
*/

const startBtn = document.getElementById('startBtn');
const backBtn = document.getElementById('backBtn');
const landing = document.getElementById('landing');
const booth = document.getElementById('booth');
const video = document.getElementById('video');
const countdownEl = document.getElementById('countdown');
const captureBtn = document.getElementById('captureBtn');
const retakeBtn = document.getElementById('retakeBtn');
const downloadBtn = document.getElementById('downloadBtn');
const stripBtn = document.getElementById('stripBtn');
const printBtn = document.getElementById('printBtn');
const timerSel = document.getElementById('timerSel');
const filterSel = document.getElementById('filterSel');
const copiesSel = document.getElementById('copiesSel');
const previewModal = document.getElementById('previewModal');
const previewImg = document.getElementById('previewImg');
const closePreview = document.getElementById('closePreview');
const frameList = document.getElementById('frameList');
const overlaySvg = document.querySelector('.overlay-svg');

let stream = null;
let lastImageDataUrl = null;
let selectedFrameId = 'default';

const PHOTO_W = 1200; // px = 4in * 300dpi
const PHOTO_H = 1800; // px = 6in * 300dpi

// Start camera and show booth
startBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
    video.srcObject = stream;
    landing.classList.remove('active');
    booth.classList.add('active');
  } catch (e) {
    alert('ไม่สามารถเข้าถึงกล้องได้ — ตรวจสอบสิทธิ์หรือเปิดผ่าน HTTPS/localhost\n\n' + e);
  }
};

// Back to landing
backBtn.onclick = () => {
  stopCamera();
  booth.classList.remove('active');
  landing.classList.add('active');
};

// Stop camera helper
function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
}

// Helper: sleep
const wait = ms => new Promise(r => setTimeout(r, ms));

// Countdown and capture
captureBtn.onclick = async () => {
  const secs = parseInt(timerSel.value || "3", 10);
  countdownEl.style.display = 'block';
  for(let i=secs;i>0;i--){
    countdownEl.textContent = i;
    await wait(1000);
  }
  countdownEl.textContent = 'Smile!';
  await wait(600);
  countdownEl.style.display = 'none';
  capturePhoto();
};

// Retake hides preview
retakeBtn.onclick = () => {
  lastImageDataUrl = null;
  previewModal.classList.add('hidden');
  previewImg.src = '';
  alert('พร้อมถ่ายใหม่');
};

// Core capture: draw video to high-res canvas (1200x1800) with cover fit
function capturePhoto(){
  const canvas = document.createElement('canvas');
  canvas.width = PHOTO_W;
  canvas.height = PHOTO_H;
  const ctx = canvas.getContext('2d');

  // Apply filter
  let filter = 'none';
  if(filterSel.value === 'grayscale') filter = 'grayscale(1)';
  if(filterSel.value === 'sepia') filter = 'sepia(1)';
  ctx.filter = filter;

  // Calculate cover scaling from video element (videoWidth/Height may be 0 if not ready)
  const vw = video.videoWidth || video.clientWidth;
  const vh = video.videoHeight || video.clientHeight;
  if(vw === 0 || vh === 0){
    alert('กล้องยังไม่พร้อม ลองอีกครั้ง');
    return;
  }
  // cover: scale to fill canvas, center-crop
  const scale = Math.max(PHOTO_W / vw, PHOTO_H / vh);
  const sw = PHOTO_W / scale;
  const sh = PHOTO_H / scale;
  const sx = (vw - sw) / 2;
  const sy = (vh - sh) / 2;

  // draw video frame onto high-res canvas
  // To draw from video element with cropping, use drawImage(video, sx, sy, sw, sh, dx, dy, dw, dh)
  ctx.drawImage(video, sx, sy, sw, sh, 0, 0, PHOTO_W, PHOTO_H);

  // Optionally draw a simplified frame overlay directly onto the canvas
  // We'll draw a semi-thin red border and some stars similar to design
  // red border
  ctx.strokeStyle = '#c21313';
  ctx.lineWidth = 24;
  ctx.strokeRect(12,12,PHOTO_W-24,PHOTO_H-24);

  // decorative star (simple)
  function drawStar(cx, cy, spikes, outerR, innerR, color){
    let rot = Math.PI / 2 * 3;
    let x = cx;
    let y = cy;
    const step = Math.PI / spikes;
    ctx.beginPath();
    ctx.moveTo(cx, cy - outerR);
    for(let i=0;i<spikes;i++){
      x = cx + Math.cos(rot) * outerR;
      y = cy + Math.sin(rot) * outerR;
      ctx.lineTo(x,y);
      rot += step;

      x = cx + Math.cos(rot) * innerR;
      y = cy + Math.sin(rot) * innerR;
      ctx.lineTo(x,y);
      rot += step;
    }
    ctx.lineTo(cx, cy - outerR);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
  }
  drawStar(180, 220, 8, 40, 18, '#c21313');
  drawStar(PHOTO_W - 160, PHOTO_H - 220, 9, 48, 20, '#c21313');
  drawStar(PHOTO_W - 200, 500, 6, 34, 14, '#c21313');

  // add logo text on bottom panel
  ctx.fillStyle = '#000';
  ctx.fillRect(0, PHOTO_H - 250, PHOTO_W, 250);
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 90px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('SENA', PHOTO_W/2 - 35, PHOTO_H - 120);
  ctx.fillStyle = '#c21313';
  ctx.fillText('✦', PHOTO_W/2 + 60, PHOTO_H - 120);
  ctx.fillStyle = '#fff';
  ctx.font = '36px Arial';
  ctx.fillText('PHOTOBOOTH', PHOTO_W/2, PHOTO_H - 60);

  const dataUrl = canvas.toDataURL('image/png');
  lastImageDataUrl = dataUrl;
  // show preview modal with scaled image for user
  previewImg.src = dataUrl;
  previewModal.classList.remove('hidden');
}

// Download single photo at 1200x1800
downloadBtn.onclick = () => {
  if(!lastImageDataUrl){
    alert('ยังไม่มีภาพ กรุณาถ่ายก่อน');
    return;
  }
  const a = document.createElement('a');
  a.href = lastImageDataUrl;
  a.download = 'SENA_4x6.png';
  a.click();
};

// Assemble vertical strip and download (N copies)
stripBtn.onclick = () => {
  if(!lastImageDataUrl){
    alert('ยังไม่มีภาพ กรุณาถ่ายก่อน');
    return;
  }
  const copies = parseInt(copiesSel.value || '3', 10);
  // strip width same as photo width; height = copies * photo height
  const stripW = PHOTO_W;
  const stripH = PHOTO_H * copies;
  const canvas = document.createElement('canvas');
  canvas.width = stripW;
  canvas.height = stripH;
  const ctx = canvas.getContext('2d');

  const img = new Image();
  img.onload = () => {
    for(let i=0;i<copies;i++){
      ctx.drawImage(img, 0, i * PHOTO_H, PHOTO_W, PHOTO_H);
    }
    // Optionally overlay a thin border around whole strip
    ctx.strokeStyle = '#000';
    ctx.lineWidth = 6;
    ctx.strokeRect(3,3,stripW-6,stripH-6);

    const url = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = url;
    a.download = `SENA_strip_${copies}x4x6.png`;
    a.click();
  };
  img.src = lastImageDataUrl;
};

// Print (open new window)
printBtn.onclick = () => {
  if(!lastImageDataUrl){
    alert('ยังไม่มีภาพ กรุณาถ่ายก่อน');
    return;
  }
  const w = window.open('');
  w.document.write('<img src="'+lastImageDataUrl+'" style="width:100%;">');
  w.document.close();
  w.focus();
  w.print();
};

// Close preview
closePreview.onclick = () => {
  previewModal.classList.add('hidden');
  previewImg.src = '';
};

// Add some simple frame thumbnails (no external assets)
const frames = [
  { id: 'none', name: 'ไม่มีกรอบ' },
  { id: 'red', name: 'กรอบแดง' },
  { id: 'circle', name: 'กรอบวงกลม' }
];
frames.forEach(f => {
  const div = document.createElement('div');
  div.className = 'frame-thumb';
  div.textContent = f.name.split('')[0];
  div.title = f.name;
  div.onclick = () => {
    document.querySelectorAll('.frame-thumb').forEach(t => t.classList.remove('selected'));
    div.classList.add('selected');
    selectedFrameId = f.id;
    // For advanced behavior we could toggle a specific overlay; current overlay drawn on canvas during capture.
  };
  frameList.appendChild(div);
});

// Graceful stop camera on page hide
document.addEventListener('visibilitychange', () => {
  if(document.hidden) stopCamera();
});

// Cleanup on unload
window.addEventListener('beforeunload', () => stopCamera());
</script>
</body>
</html>
