<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SENA | THE PRESTIGE PHOTOBOOTH</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Inter:wght@100;300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #D4AF37;
            --gold-gradient: linear-gradient(135deg, #f3e5ab 0%, #d4af37 50%, #aa8828 100%);
            --bg: #030303;
            --glass: rgba(255, 255, 255, 0.03);
            --glass-heavy: rgba(10, 10, 10, 0.85);
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Inter', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background: var(--bg); color: #fff;
            font-family: var(--font-sans); overflow: hidden;
        }

        /* --- World-class Background Mesh --- */
        .mesh-bg {
            position: fixed; inset: 0; z-index: -1;
            background: var(--bg);
            overflow: hidden;
        }
        .mesh-sphere {
            position: absolute; width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(212, 175, 55, 0.08) 0%, transparent 70%);
            border-radius: 50%; filter: blur(80px);
            animation: meshMove 20s infinite alternate;
        }
        @keyframes meshMove {
            0% { transform: translate(-10%, -10%); }
            100% { transform: translate(30%, 20%); }
        }

        /* --- Smooth Screen Transitions --- */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; visibility: hidden;
            transform: scale(1.05);
            transition: all 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
            z-index: 10;
        }
        .screen.active { 
            opacity: 1; visibility: visible; transform: scale(1);
        }

        /* --- หน้า HOME: High-End Fashion Look --- */
        #screen-home {
            justify-content: center; align-items: center;
            background: url('bg_start.png') no-repeat center center;
            background-size: cover;
        }
        #screen-home::before {
            content: ''; position: absolute; inset: 0;
            background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.8) 100%);
        }

        .main-logo {
            width: 280px; z-index: 2;
            filter: drop-shadow(0 0 30px rgba(0,0,0,0.5));
            margin-bottom: 60px;
            animation: logoEntrance 1.5s ease-out;
        }
        @keyframes logoEntrance { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .btn-luxury {
            z-index: 2; background: transparent;
            border: 1px solid rgba(212, 175, 55, 0.5);
            padding: 20px 60px; color: var(--gold);
            font-family: var(--font-serif); font-size: 1.2rem;
            letter-spacing: 5px; cursor: pointer;
            transition: 0.5s cubic-bezier(0.2, 1, 0.3, 1);
            position: relative; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .btn-luxury:hover {
            color: #000; border-color: var(--gold);
            background: var(--gold); box-shadow: 0 0 50px rgba(212, 175, 55, 0.3);
        }

        /* --- หน้า CAM: Cinematic Experience --- */
        #screen-cam { background: #000; }
        
        .cam-container {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }
        video#video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); transition: filter 0.5s; }

        .overlay-elements {
            position: absolute; inset: 40px; border: 1px solid rgba(255,255,255,0.1);
            pointer-events: none; z-index: 5;
        }
        
        .shutter-panel {
            height: 180px; background: linear-gradient(to top, #000, transparent);
            display: flex; justify-content: center; align-items: center;
            position: relative; z-index: 20;
        }

        .shutter-outer {
            width: 90px; height: 90px; border: 2px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .shutter-inner {
            width: 74px; height: 74px; background: #fff; border-radius: 50%;
            transition: 0.2s;
        }
        .shutter-outer:active .shutter-inner { transform: scale(0.8); background: var(--gold); }

        .side-dock {
            position: absolute; right: 30px; top: 50%; transform: translateY(-50%);
            display: flex; flex-direction: column; gap: 30px; z-index: 30;
        }
        .dock-item {
            width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
            background: var(--glass); border-radius: 50%; backdrop-filter: blur(10px);
            cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: 0.3s;
        }
        .dock-item:hover { background: rgba(255,255,255,0.1); border-color: var(--gold); }

        /* --- หน้า RESULT: Art Gallery Reveal --- */
        #screen-result {
            flex-direction: row; background: #050505;
        }
        
        .result-view {
            flex: 1.4; display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle, #111 0%, #000 100%);
            perspective: 1000px;
        }
        .photo-print {
            height: 80%; border: 12px solid #fff;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            transform: rotateY(-10deg) rotateX(5deg);
            transition: 1s cubic-bezier(0.2, 0.8, 0.2, 1.2);
        }
        .photo-print.reveal { transform: rotateY(0) rotateX(0); }

        .result-info {
            flex: 0.6; background: var(--glass-heavy);
            backdrop-filter: blur(30px); padding: 60px 40px;
            display: flex; flex-direction: column; border-left: 1px solid rgba(255,255,255,0.05);
        }

        .gold-text {
            font-family: var(--font-serif); color: var(--gold);
            font-size: 2.5rem; margin-bottom: 10px; font-style: italic;
        }

        .btn-finish {
            background: var(--gold); color: #000; border: none;
            padding: 18px; font-weight: 600; font-size: 1rem;
            margin-top: auto; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .btn-finish:hover { background: #fff; transform: translateY(-3px); }

        .loader-wrap { margin: 30px 0; }
        .bar-bg { height: 2px; background: rgba(255,255,255,0.1); width: 100%; margin-top: 10px; }
        .bar-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s; }

        #flash {
            position: fixed; inset: 0; background: #fff; z-index: 1000;
            opacity: 0; pointer-events: none;
        }

        @media (max-width: 1000px) {
            #screen-result { flex-direction: column; }
            .result-info { flex: none; height: 50%; width: 100%; padding: 30px; }
            .photo-print { height: 70%; }
        }
    </style>
</head>
<body>

    <div class="mesh-bg">
        <div class="mesh-sphere" style="top: 10%; left: 10%;"></div>
        <div class="mesh-sphere" style="bottom: 10%; right: 10%; animation-delay: -5s;"></div>
    </div>

    <div id="screen-home" class="screen active">
        <img src="logo_sena.png" class="main-logo" alt="SENA">
        <button class="btn-luxury" onclick="OS.start()">ENTER EXPERIENCE</button>
        <p style="position:absolute; bottom:40px; font-size:0.7rem; letter-spacing:3px; opacity:0.4;">EST. 2024 • SENA MEMORIES</p>
    </div>

    <div id="screen-cam" class="screen">
        <div class="overlay-elements"></div>
        <div class="cam-container">
            <video id="video-feed" autoplay playsinline muted></video>
            <div id="countdown" style="position:absolute; font-family:var(--font-serif); font-size:12rem; color:#fff; display:none; z-index:100; text-shadow:0 0 50px rgba(0,0,0,0.5);">3</div>
            
            <div class="side-dock">
                <div class="dock-item" onclick="OS.toggleCamFlip()">↻</div>
                <div class="dock-item" onclick="OS.toggleTimer()" id="btn-timer" style="font-size:0.8rem; font-weight:bold;">3s</div>
                <div class="dock-item" onclick="OS.toggleFlash()">⚡</div>
            </div>
        </div>

        <div class="shutter-panel">
            <div class="shutter-outer" onclick="OS.snap()">
                <div class="shutter-inner"></div>
            </div>
            
            <div style="position:absolute; left:40px; display:flex; gap:20px;">
                <span onclick="OS.filter('normal', this)" style="cursor:pointer; font-size:0.7rem; letter-spacing:1px; color:var(--gold);">NATURAL</span>
                <span onclick="OS.filter('bw', this)" style="cursor:pointer; font-size:0.7rem; letter-spacing:1px; opacity:0.5;">NOIR</span>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="result-view">
            <img id="final-img" class="photo-print" alt="Result">
        </div>
        <div class="result-info">
            <div class="gold-text">The Prestige</div>
            <p style="font-weight:100; opacity:0.6; line-height:1.6;">Your memory has been captured in high definition and is being processed for our digital archives.</p>
            
            <div class="loader-wrap">
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; letter-spacing:1px;">
                    <span id="log-text">UPLOADING TO CLOUD</span>
                    <span id="pct">0%</span>
                </div>
                <div class="bar-bg"><div class="bar-fill" id="load-fill"></div></div>
            </div>

            <div id="qr-wrap" style="display:none; text-align:center; margin-bottom:30px;">
                <div id="qrcode" style="display:inline-block; padding:10px; background:#fff; border-radius:4px;"></div>
                <p style="font-size:0.7rem; margin-top:10px; opacity:0.5;">SCAN TO DOWNLOAD</p>
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button class="btn-finish" style="background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.1);" onclick="OS.download()">Save File</button>
                <button class="btn-finish" onclick="OS.restart()">New Session</button>
            </div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="hidden-canvas" style="display:none"></canvas>

    <script>
        const FIXED_FRAME_URL = 'frame.png'; 
        const API_KEY = 'ffc90ad0bc5c7e0c056b68ef7430304a'; 

        const OS = (function() {
            let s = { filter: 'normal', frameImg: null, photos: [], stream: null, processing: false, timer: 3, flash: true, facingMode: 'user', mirror: true };
            const D = {
                screens: document.querySelectorAll('.screen'),
                video: document.getElementById('video-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown'),
                final: document.getElementById('final-img'),
                flash: document.getElementById('flash')
            };

            const Aud = {
                play: (freq) => {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const o = ctx.createOscillator(); const g = ctx.createGain();
                    o.connect(g); g.connect(ctx.destination);
                    o.frequency.setValueAtTime(freq, ctx.currentTime);
                    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                    o.start(); o.stop(ctx.currentTime + 0.5);
                }
            };

            window.onload = () => {
                const img = new Image(); img.src = FIXED_FRAME_URL;
                img.onload = () => s.frameImg = img;
            };

            async function start() {
                Aud.play(440);
                await initCamera();
                showScreen('screen-cam');
            }

            async function initCamera() {
                if(s.stream) s.stream.getTracks().forEach(t=>t.stop());
                s.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: s.facingMode, width: 1920, height: 1080 } });
                D.video.srcObject = s.stream;
            }

            function showScreen(id) {
                D.screens.forEach(scr => scr.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            }

            async function snap() {
                if(s.processing) return;
                s.processing = true;
                s.photos = [];
                for(let i=0; i<3; i++) {
                    await countdown();
                    await capture();
                }
                processResult();
            }

            function countdown() {
                return new Promise(r => {
                    let c = s.timer; D.count.innerText = c; D.count.style.display = 'block';
                    const t = setInterval(() => {
                        c--; 
                        if(c>0) { D.count.innerText = c; Aud.play(600); }
                        else { clearInterval(t); D.count.style.display = 'none'; r(); }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    if(s.flash) { D.flash.style.opacity = 1; setTimeout(()=>D.flash.style.opacity=0, 100); }
                    const cvs = document.createElement('canvas');
                    cvs.width = D.video.videoWidth; cvs.height = D.video.videoHeight;
                    const ctx = cvs.getContext('2d');
                    if(s.mirror) { ctx.translate(cvs.width, 0); ctx.scale(-1, 1); }
                    ctx.drawImage(D.video, 0, 0);
                    if(s.filter === 'bw') {
                        const id = ctx.getImageData(0,0,cvs.width,cvs.height);
                        for(let i=0; i<id.data.length; i+=4) {
                            const v = 0.3*id.data[i] + 0.59*id.data[i+1] + 0.11*id.data[i+2];
                            id.data[i] = id.data[i+1] = id.data[i+2] = v;
                        }
                        ctx.putImageData(id, 0, 0);
                    }
                    s.photos.push(cvs);
                    setTimeout(r, 600);
                });
            }

            function processResult() {
                const stripW = 600; const photoH = 405; const head = 150;
                const H = head + (photoH * 3) + (25 * 2) + 100;
                D.canvas.width = stripW; D.canvas.height = H;
                const ctx = D.canvas.getContext('2d');
                ctx.fillStyle = "#fff"; ctx.fillRect(0,0,stripW,H);
                
                s.photos.forEach((p, i) => {
                    ctx.drawImage(p, 30, head + (i*(photoH+25)), 540, photoH);
                });
                if(s.frameImg) ctx.drawImage(s.frameImg, 0, 0, stripW, H);

                D.final.src = D.canvas.toDataURL('image/jpeg', 0.9);
                showScreen('screen-result');
                setTimeout(() => D.final.classList.add('reveal'), 100);
                upload(D.final.src);
                confetti({ colors: ['#D4AF37', '#ffffff'] });
            }

            async function upload(base64) {
                const fill = document.getElementById('load-fill');
                const pct = document.getElementById('pct');
                let p = 0; const inv = setInterval(() => { if(p<90) p+=5; fill.style.width=p+'%'; pct.innerText=p+'%'; }, 100);
                
                try {
                    const fd = new FormData(); fd.append("image", base64.split(',')[1]);
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, { method: "POST", body: fd });
                    const data = await res.json();
                    clearInterval(inv); fill.style.width='100%'; pct.innerText='100%';
                    if(data.success) {
                        new QRCode(document.getElementById("qrcode"), { text: data.data.url, width: 100, height: 100, colorDark: "#000" });
                        document.getElementById('qr-wrap').style.display = 'block';
                    }
                } catch(e) { clearInterval(inv); }
            }

            return {
                start, 
                toggleCamFlip: () => { s.facingMode = s.facingMode === 'user' ? 'environment' : 'user'; initCamera(); },
                toggleTimer: () => { s.timer = s.timer === 3 ? 5 : 3; document.getElementById('btn-timer').innerText = s.timer+'s'; },
                toggleFlash: () => { s.flash = !s.flash; },
                filter: (f, el) => { s.filter = f; document.querySelectorAll('.shutter-panel span').forEach(s=>s.style.opacity=0.5); el.style.opacity=1; },
                snap, download: () => { const a = document.createElement('a'); a.download = 'SENA_MEMS.jpg'; a.href = D.final.src; a.click(); },
                restart: () => location.reload()
            };
        })();
    </script>
</body>
</html>
