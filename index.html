<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SENA 125TH | FINAL ORIENTATION</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&family=Playfair+Display:wght@400;700;900&family=Prompt:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-color: #0a0a0a;
            --gold-main: #D4AF37;
            --gold-light: #F3E5AB;
            --text-main: #E0E0E0;
            --accent: #D4AF37;
            --font-ui: 'DM Sans', sans-serif;
            --font-head: 'Playfair Display', serif; /* ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏£‡∏π‡∏´‡∏£‡∏≤ */
            --font-thai: 'Prompt', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; -webkit-user-select: none; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-color);
            height: 100vh; height: 100dvh;
            width: 100vw;
            overflow: hidden;
            color: var(--text-main);
            font-family: var(--font-ui);
            display: flex; justify-content: center; align-items: center;
            touch-action: none;
        }

        /* --- Screens --- */
        #monitor {
            width: 100%; height: 100%;
            position: relative;
            background: radial-gradient(circle at center, #222 0%, #000 100%);
            display: flex; flex-direction: column;
        }

        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.6s ease;
            z-index: 10;
            background: #000;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* --- Home Screen --- */
        #screen-home {
            justify-content: center; align-items: center; text-align: center;
            background: url('https://www.transparenttextures.com/patterns/stardust.png'), radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
        }
        
        .logo-text {
            font-family: var(--font-head);
            color: var(--gold-main);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 20px;
        }

        .main-title {
            font-family: var(--font-head);
            font-size: clamp(2.5rem, 6vw, 5rem);
            font-weight: 700; 
            background: linear-gradient(45deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.1; margin-bottom: 5vh;
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.3);
            animation: shimmer 3s infinite linear;
        }
        @keyframes shimmer { 0%{background-position: -200%;} 100%{background-position: 200%;} }

        .btn-start {
            background: transparent; border: 1px solid var(--gold-main);
            padding: 1.5rem 4rem; color: var(--gold-light);
            font-family: var(--font-ui); font-size: 1.2rem; letter-spacing: 2px;
            cursor: pointer; position: relative;
            transition: 0.3s;
            overflow: hidden;
        }
        .btn-start::before {
            content:''; position: absolute; top:0; left:0; width:0%; height:100%;
            background: var(--gold-main); transition: 0.3s; z-index: -1;
        }
        .btn-start:active::before { width: 100%; }
        .btn-start:active { color: #000; transform: scale(0.95); }

        /* --- Camera Screen --- */
        #screen-cam { justify-content: space-between; background: #000; }
        
        .ui-top {
            height: 60px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            font-family: var(--font-ui); font-size: 1.2rem; z-index: 20;
            border-bottom: 1px solid #333;
        }

        .viewport { flex: 1; position: relative; overflow: hidden; background: #000; display: flex; justify-content: center; align-items: center;}
        video#video-feed { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        .cam-sidebar {
            position: absolute; top: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 15px; z-index: 50;
        }
        .tool-btn {
            width: 45px; height: 45px; background: rgba(255,255,255,0.1); 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; color: #fff;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem; cursor: pointer; backdrop-filter: blur(4px);
        }

        #countdown {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            font-family: var(--font-head); font-size: 12rem; color: var(--gold-light); 
            display: none; z-index: 100; text-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .ui-controls {
            height: 140px; background: #111;
            display: flex; align-items: center; justify-content: center; gap: 20px;
            padding-bottom: 10px; z-index: 20; border-top: 1px solid #333;
        }
        .btn-shutter {
            width: 80px; height: 80px; border: 4px solid #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .shutter-inner { width: 68px; height: 68px; background: #fff; border-radius: 50%; transition: 0.1s; }
        .btn-shutter:active .shutter-inner { transform: scale(0.9); background: var(--gold-main); }

        /* --- Result Screen --- */
        #screen-result { 
            justify-content: center; align-items: center; background: #080808; 
            flex-direction: row; gap: 4vw; padding: 20px;
        }
        
        .printer-wrapper { 
            position: relative; height: 75vh; 
            aspect-ratio: 600/1600; /* Approximate ratio of the uploaded image */
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }
        .printer-slot {
            width: 100%; height: 100%; background: #222; overflow: hidden;
            display:flex; justify-content: center; align-items: center;
        }
        .preview-img { width: 100%; height: 100%; object-fit: contain; display: block; }
        
        .result-sidebar {
            display: flex; flex-direction: column; align-items: center; gap: 15px;
            width: 300px;
        }
        
        .btn-action {
            padding: 14px; font-family: var(--font-ui); font-weight: 700;
            background: var(--gold-main); color: #000; border: none; cursor: pointer; 
            width: 100%; border-radius: 2px; text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; justify-content: center; gap:10px;
        }
        .btn-action.outline { background: transparent; border: 1px solid #555; color: #aaa; }
        .btn-action.outline:hover { border-color: #fff; color: #fff; }

        .hidden-upload { display:none; }
        .upload-trigger { font-size: 0.7rem; color: #444; margin-top: 20px; cursor: pointer; text-decoration: underline;}

        #flash { position: fixed; inset: 0; background: #fff; z-index: 9999; opacity: 0; pointer-events: none; }
        .do-flash { animation: flashAnim 0.3s ease-out; }
        @keyframes flashAnim { 0% {opacity: 1;} 100% {opacity: 0;} }

        @media (max-width: 1024px) {
            #screen-result { flex-direction: column; padding-top: 40px; justify-content: flex-start; overflow-y: auto;}
            .printer-wrapper { height: 60vh; margin-bottom: 20px; flex-shrink: 0; }
            .result-sidebar { width: 90%; padding-bottom: 40px; }
        }
    </style>
</head>
<body>

    <input type="file" id="frame-uploader" class="hidden-upload" accept="image/*" onchange="OS.loadCustomFrame(this)">

    <div id="monitor">
        
        <div id="screen-home" class="screen active">
            <div class="logo-text">SENA DEVELOPMENT</div>
            <div class="main-title">FINAL<br>ORIENTATION<br>DAY</div>
            <div style="color: var(--gold-main); font-family: 'Prompt'; margin-bottom: 30px; font-size: 1.2rem;">5 FEBRUARY 2026</div>
            
            <button class="btn-start" onclick="OS.start()">START PHOTOBOOTH</button>
            
            <div class="upload-trigger" onclick="document.getElementById('frame-uploader').click()">
                (Custom Frame: Click to load 'frame.png' manually if missing)
            </div>
        </div>

        <div id="screen-cam" class="screen">
            <div class="ui-top">
                <div style="color:var(--gold-main)">‚óè REC</div>
                <div id="clock">00:00</div>
            </div>
            
            <div class="viewport">
                <video id="video-feed" autoplay playsinline muted></video>
                <div id="countdown">3</div>
                
                <div class="cam-sidebar">
                    <div class="tool-btn" onclick="OS.toggleCamFlip()">‚Üª</div>
                    <div class="tool-btn" onclick="OS.toggleTimer()" id="btn-timer">3s</div>
                    <div class="tool-btn" onclick="OS.toggleGrid()">#</div>
                </div>
            </div>

            <div class="ui-controls">
                <div class="btn-shutter" onclick="OS.snap()">
                    <div class="shutter-inner"></div>
                </div>
            </div>
        </div>

        <div id="screen-result" class="screen">
            <div class="printer-wrapper">
                <div class="printer-slot">
                    <img id="final-img" class="preview-img" alt="Result">
                </div>
            </div>

            <div class="result-sidebar">
                <h3 style="font-family:var(--font-head); color:var(--gold-main); margin:0;">READY TO PRINT</h3>
                
                <button class="btn-action" onclick="OS.download()">DOWNLOAD IMAGE</button>
                <button class="btn-action outline" style="border-color:var(--gold-main); color:var(--gold-main)" onclick="OS.downloadVideo()">üé• DOWNLOAD VIDEO</button>
                <button class="btn-action outline" onclick="location.reload()">HOME</button>
            </div>
        </div>
    </div>

    <div id="flash"></div>
    <canvas id="hidden-canvas" style="display:none"></canvas> 

    <script>
        const OS = (function() {
            
            // CONFIG: Adjust coordinates here if the image changes
            // Based on a standard width of 600px for the canvas
            const CONFIG = {
                stripWidth: 600,
                shots: 3,
                frameSrc: 'frame.png', // Default filename to look for
                
                // Coordinates for the 3 photo boxes (Estimated based on your image)
                // x, y, w, h
                layout: [
                    { x: 38, y: 310, w: 524, h: 393 },  // Top Box
                    { x: 38, y: 735, w: 524, h: 393 },  // Middle Box
                    { x: 38, y: 1160, w: 524, h: 393 }  // Bottom Box
                ]
            };

            let s = { 
                photos: [], 
                stream: null, 
                processing: false,
                timer: 3,
                mirror: true,
                frameImage: null
            };

            const D = {
                screens: {
                    home: document.getElementById('screen-home'),
                    cam: document.getElementById('screen-cam'),
                    res: document.getElementById('screen-result')
                },
                video: document.getElementById('video-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown'),
                flash: document.getElementById('flash'),
                final: document.getElementById('final-img'),
                btnTimer: document.getElementById('btn-timer')
            };

            // Preload Frame
            function initFrame() {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = CONFIG.frameSrc;
                img.onload = () => { s.frameImage = img; console.log("Frame Loaded"); };
                img.onerror = () => { console.log("Frame not found. Use custom upload."); };
            }

            window.onload = () => {
                initFrame();
                setInterval(() => {
                    const d = new Date();
                    document.getElementById('clock').innerText = d.getHours().toString().padStart(2,'0')+":"+d.getMinutes().toString().padStart(2,'0');
                }, 1000);
            };

            function loadCustomFrame(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = () => { s.frameImage = img; alert("Custom Frame Loaded!"); };
                        img.src = e.target.result;
                    }
                    reader.readAsDataURL(input.files[0]);
                }
            }

            async function start() {
                // If no frame is loaded, warn but proceed
                if(!s.frameImage) alert("Warning: 'frame.png' not found. You can click the text below START to upload it manually, or proceed with a plain background.");
                await initCamera();
                switchScreen('cam');
            }

            function switchScreen(name) {
                Object.values(D.screens).forEach(s => s.classList.remove('active'));
                D.screens[name].classList.add('active');
            }

            async function initCamera() {
                if(s.stream) return;
                try {
                    s.stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'user', width: {ideal: 1280}, height: {ideal: 720} },
                        audio: false
                    });
                    D.video.srcObject = s.stream;
                } catch(e) { alert("Camera Error"); }
            }

            function toggleCamFlip() {
                // Simplified for demo
                s.mirror = !s.mirror;
                D.video.style.transform = s.mirror ? "scaleX(-1)" : "scaleX(1)";
            }
            function toggleTimer() {
                s.timer = s.timer === 3 ? 5 : 3;
                D.btnTimer.innerText = s.timer + "s";
            }
            function toggleGrid() { D.video.parentElement.classList.toggle('grid-on'); }

            async function snap() {
                if(s.processing) return;
                s.processing = true; s.photos = [];
                
                for(let i=0; i<CONFIG.shots; i++) {
                    await countdown(s.timer);
                    await capture();
                    await new Promise(r => setTimeout(r, 500));
                }
                
                s.processing = false;
                processResult();
            }

            function countdown(n) {
                return new Promise(r => {
                    let c = n; D.count.style.display = 'block'; D.count.innerText = c;
                    const t = setInterval(() => {
                        c--;
                        if(c>0) D.count.innerText = c; 
                        else { clearInterval(t); D.count.style.display = 'none'; r(); }
                    }, 1000);
                });
            }

            function capture() {
                return new Promise(r => {
                    D.flash.classList.add('do-flash');
                    setTimeout(() => D.flash.classList.remove('do-flash'), 300);
                    
                    const cvs = document.createElement('canvas');
                    // Capture high res
                    const vidW = D.video.videoWidth;
                    const vidH = D.video.videoHeight;
                    
                    // Crop to 4:3 Aspect Ratio (center crop)
                    const targetRatio = 4/3;
                    let cropW, cropH, cropX, cropY;

                    if (vidW / vidH > targetRatio) {
                        cropH = vidH; cropW = cropH * targetRatio;
                        cropX = (vidW - cropW) / 2; cropY = 0;
                    } else {
                        cropW = vidW; cropH = cropW / targetRatio;
                        cropX = 0; cropY = (vidH - cropH) / 2;
                    }

                    cvs.width = cropW; cvs.height = cropH;
                    const ctx = cvs.getContext('2d');
                    
                    if(s.mirror) {
                        ctx.translate(cvs.width, 0); ctx.scale(-1, 1);
                    }
                    ctx.drawImage(D.video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
                    
                    s.photos.push(cvs);
                    setTimeout(r, 200);
                });
            }

            function processResult() {
                renderCanvas();
                D.final.src = D.canvas.toDataURL('image/jpeg', 0.95);
                switchScreen('res');
                confetti({ particleCount: 150, colors: ['#D4AF37', '#FFF', '#000'] });
            }

            function renderCanvas(animOffset = 0) {
                const W = CONFIG.stripWidth;
                // Height is dynamic based on frame image ratio, fallback to 1600
                const H = s.frameImage ? (s.frameImage.height / s.frameImage.width) * W : 1600;
                
                D.canvas.width = W; D.canvas.height = H;
                const ctx = D.canvas.getContext('2d');

                // 1. Draw Frame Background First (Because uploaded image likely has white boxes as opaque)
                // Actually, if the boxes are white in the image, we should draw photos ON TOP of them.
                if (s.frameImage) {
                    ctx.drawImage(s.frameImage, 0, 0, W, H);
                } else {
                    // Fallback Background
                    ctx.fillStyle = "#111"; ctx.fillRect(0,0,W,H);
                    ctx.fillStyle = "#D4AF37"; ctx.font = "bold 40px sans-serif";
                    ctx.textAlign = "center"; ctx.fillText("FRAME NOT LOADED", W/2, H/2);
                }

                // 2. Draw Photos over the white boxes
                // Handle animation offset for video
                let photosToDraw = [...s.photos];
                for(let k=0; k<animOffset; k++) photosToDraw.unshift(photosToDraw.pop());

                CONFIG.layout.forEach((box, index) => {
                    if (photosToDraw[index]) {
                        // Keep aspect ratio cover
                        // We draw directly into the defined box area
                        ctx.drawImage(photosToDraw[index], box.x, box.y, box.w, box.h);
                        
                        // Optional: Add inner shadow/border to blend better
                        ctx.strokeStyle = "rgba(0,0,0,0.1)";
                        ctx.lineWidth = 2;
                        ctx.strokeRect(box.x, box.y, box.w, box.h);
                    }
                });
            }

            function download() {
                const a = document.createElement('a');
                a.download = `SENA_ORIENTATION_${Date.now()}.jpg`;
                a.href = D.final.src;
                a.click();
            }

            async function downloadVideo() {
                const stream = D.canvas.captureStream(30);
                const recorder = new MediaRecorder(stream);
                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = `SENA_VIDEO_${Date.now()}.webm`;
                    a.click();
                    // Reset
                    renderCanvas(0); D.final.src = D.canvas.toDataURL('image/jpeg', 0.95);
                };

                recorder.start();
                let shift = 0;
                const int = setInterval(() => {
                    shift++;
                    renderCanvas(shift);
                    if (shift > 10) { // Approx 5-6 seconds
                        clearInterval(int);
                        recorder.stop();
                    }
                }, 500);
            }

            return { start, toggleCamFlip, toggleTimer, toggleGrid, snap, download, downloadVideo, loadCustomFrame };
        })();
    </script>
</body>
</html>
