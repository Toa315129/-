<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SENA PHOTOBOOTH | The Graduation</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Prompt:wght@200;300;400;500&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-deep: #000000;
            --gold: #D4AF37;
            --gold-soft: #F3E5AB;
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.15);
            --radius: 24px; /* ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ */
            --font-head: 'Playfair Display', serif;
            --font-body: 'Prompt', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0; padding: 0;
            background: var(--bg-deep);
            color: #fff;
            height: 100vh; height: 100dvh; width: 100vw;
            overflow: hidden;
            font-family: var(--font-body);
            display: flex; justify-content: center; align-items: center;
        }

        /* --- Background & Particles --- */
        .luxury-bg {
            position: absolute; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% 30%, #1a1a1a 0%, #000000 90%);
        }
        /* Gradient Noise for Texture */
        .noise-overlay {
            position: absolute; inset: 0; opacity: 0.05; pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        /* --- UI Screens --- */
        .screen {
            position: absolute; inset: 0;
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none;
            transition: opacity 0.6s cubic-bezier(0.25, 1, 0.5, 1);
            z-index: 10;
        }
        .screen.active { opacity: 1; pointer-events: auto; }

        /* --- 1. HOME SCREEN --- */
        #screen-home {
            justify-content: center; align-items: center; text-align: center;
            background: url('bg_start.png') no-repeat center center;
            background-size: cover;
        }
        .logo-container {
            margin-bottom: 50px;
            animation: floatLogo 6s ease-in-out infinite;
        }
        .main-logo {
            width: 60%; max-width: 320px; height: auto;
            filter: drop-shadow(0 0 20px rgba(212, 175, 55, 0.3));
        }
        @keyframes floatLogo { 0%, 100% {transform: translateY(0);} 50% {transform: translateY(-10px);} }

        /* Modern Start Button */
        .btn-start {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 18px 60px;
            border-radius: 50px; /* Pill Shape */
            font-family: var(--font-head); font-size: 1.5rem; letter-spacing: 2px;
            cursor: pointer; transition: 0.4s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }
        .btn-start:active { transform: scale(0.95); }
        .btn-start::after {
            content: ''; position: absolute; inset: 0; 
            background: radial-gradient(circle, rgba(212,175,55,0.4) 0%, transparent 70%);
            opacity: 0; transition: 0.4s;
        }
        .btn-start:hover::after { opacity: 1; }

        /* --- 2. CAMERA SCREEN --- */
        #screen-cam {
            background: #000; padding: 20px;
        }

        .cam-wrapper {
            flex: 1; position: relative; width: 100%; height: 100%;
            border-radius: var(--radius); overflow: hidden;
            box-shadow: 0 0 0 1px var(--glass-border);
            display: flex; justify-content: center; align-items: center;
            background: #111;
        }
        
        video#video-feed { 
            width: 100%; height: 100%; object-fit: cover; 
            transform: scaleX(-1); border-radius: var(--radius);
        }

        /* Minimal UI Overlay */
        .cam-ui-layer {
            position: absolute; inset: 0; padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between;
            z-index: 20;
        }

        .top-bar {
            display: flex; justify-content: center;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            padding: 8px 20px; border-radius: 30px; align-self: center;
            font-size: 0.9rem; color: rgba(255,255,255,0.8);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* Countdown */
        #countdown-display {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 12rem; font-family: var(--font-head); color: #fff;
            text-shadow: 0 0 40px rgba(212,175,55,0.6);
            opacity: 0; transition: 0.2s; pointer-events: none;
        }

        /* Bottom Controls */
        .bottom-controls {
            display: flex; flex-direction: column; gap: 20px; align-items: center;
            margin-bottom: 20px;
        }

        .filter-bar {
            display: flex; gap: 15px; background: rgba(0,0,0,0.5);
            padding: 8px 15px; border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        .filter-dot {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: 0.3s;
        }
        .filter-dot.active { border-color: var(--gold); transform: scale(1.2); }

        .shutter-row {
            display: flex; align-items: center; justify-content: center; gap: 40px; width: 100%;
        }
        
        .btn-icon {
            font-size: 1.2rem; color: #fff; opacity: 0.6; cursor: pointer;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: rgba(255,255,255,0.05); transition: 0.3s;
        }
        .btn-icon:hover { opacity: 1; background: rgba(255,255,255,0.1); }

        .shutter-btn {
            width: 80px; height: 80px; border-radius: 50%;
            background: #fff; border: 4px solid rgba(255,255,255,0.3);
            background-clip: padding-box; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ border ‡πÅ‡∏¢‡∏Å‡∏Å‡∏±‡∏ö bg */
            cursor: pointer; transition: 0.2s;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
        }
        .shutter-btn:active { transform: scale(0.9); background: var(--gold-soft); }

        /* --- 3. RESULT SCREEN (KIOSK STYLE) --- */
        #screen-result {
            background: #050505;
            flex-direction: column; /* Stack vertical for mobile/tablet */
            padding: 30px;
        }
        
        /* Shelf for the photo */
        .photo-shelf {
            flex: 1; width: 100%; display: flex; justify-content: center; align-items: center;
            perspective: 1000px;
        }
        
        .final-photo-card {
            max-height: 70vh; width: auto; max-width: 90%;
            border: 10px solid #fff; /* Border like a real photo */
            box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            transform-origin: top center;
            animation: printExit 1.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }
        
        @keyframes printExit {
            from { transform: translateY(-50px) rotateX(10deg); opacity: 0; }
            to { transform: translateY(0) rotateX(0deg); opacity: 1; }
        }

        /* Action Buttons Area */
        .actions-tray {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.1);
            border-radius: var(--radius);
            padding: 25px; width: 100%; max-width: 500px; margin: 0 auto;
            display: flex; flex-direction: column; gap: 15px;
        }

        .btn-main-action {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            font-family: var(--font-body); font-size: 1rem; font-weight: 500;
            cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px;
            transition: 0.3s;
        }
        
        .btn-gold { background: var(--gold); color: #000; }
        .btn-gold:hover { background: #E5C158; box-shadow: 0 5px 15px rgba(212,175,55,0.3); }
        
        .btn-glass { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.1); }
        .btn-glass:hover { background: rgba(255,255,255,0.2); }

        .btn-row { display: flex; gap: 10px; }

        /* --- PRINT FIX --- */
        @media print {
            @page {
                size: 4in 6in; /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© 4x6 ‡∏ô‡∏¥‡πâ‡∏ß */
                margin: 0; /* ‡∏ï‡∏±‡∏î‡∏Ç‡∏≠‡∏ö‡∏Ç‡∏≤‡∏ß‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î */
            }
            body, html {
                margin: 0; padding: 0; width: 100%; height: 100%;
                background: white; visibility: hidden;
            }
            /* ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á */
            .screen, .luxury-bg, .noise-overlay { display: none !important; }

            /* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏π‡∏õ */
            #print-only-img {
                display: block !important; visibility: visible !important;
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                width: 100%; height: 100%;
                object-fit: cover; /* ‡∏¢‡∏∑‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô */
                z-index: 9999;
            }
        }
        #print-only-img { display: none; } /* ‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ */

        /* Flash */
        #flash-overlay {
            position: fixed; inset: 0; background: #fff; z-index: 100;
            opacity: 0; pointer-events: none; transition: opacity 0.1s;
        }
    </style>
</head>
<body>

    <div class="luxury-bg"></div>
    <div class="noise-overlay"></div>

    <div id="screen-home" class="screen active">
        <div class="logo-container">
            <img src="logo_sena.png" class="main-logo" alt="SENA">
        </div>
        <button class="btn-start" onclick="App.start()">Start Photo Booth</button>
        <p style="margin-top:20px; font-size:0.8rem; opacity:0.6; letter-spacing:2px;">TOUCH TO START</p>
    </div>

    <div id="screen-cam" class="screen">
        <div class="cam-wrapper">
            <video id="video-feed" autoplay playsinline muted></video>
            <div id="countdown-display">3</div>
            
            <div class="cam-ui-layer">
                <div class="top-bar">
                    <span id="shot-counter">1 / 3</span>
                </div>
                
                <div class="bottom-controls">
                    <div class="filter-bar">
                        <div class="filter-dot active" style="background:linear-gradient(45deg, #ccc, #fff);" onclick="App.filter('normal', this)"></div>
                        <div class="filter-dot" style="background:#f5d0d0;" onclick="App.filter('beauty', this)"></div> <div class="filter-dot" style="background:#555;" onclick="App.filter('bw', this)"></div> <div class="filter-dot" style="background:sepia(100%);" onclick="App.filter('film', this)"></div> </div>

                    <div class="shutter-row">
                        <div class="btn-icon" onclick="App.toggleTimer()" id="btn-timer">‚è± 3s</div>
                        <div class="shutter-btn" onclick="App.snap()"></div>
                        <div class="btn-icon" onclick="App.toggleCam()">‚Üª</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div class="photo-shelf">
            <img id="final-img" class="final-photo-card" src="" alt="Photo Strip">
        </div>

        <div class="actions-tray">
            <button class="btn-main-action btn-gold" onclick="App.printPhoto()">
                <span>üñ®Ô∏è Print Photo</span>
            </button>
            <div class="btn-row">
                <button class="btn-main-action btn-glass" style="flex:1" onclick="App.download()">
                    <span>Download</span>
                </button>
                <button class="btn-main-action btn-glass" style="flex:1" onclick="App.restart()">
                    <span>New Photo</span>
                </button>
            </div>
            <div id="qr-area" style="display:none; text-align:center; background:#fff; padding:10px; border-radius:10px; margin-top:10px;">
                <div id="qrcode"></div>
                <small style="color:#000; display:block; margin-top:5px;">Scan to Save</small>
            </div>
        </div>
    </div>

    <div id="flash-overlay"></div>
    <img id="print-only-img" src="">
    <canvas id="hidden-canvas" style="display:none"></canvas>

    <script>
        const App = (function() {
            // Config
            const CONFIG = {
                shots: 3,
                stripWidth: 1200, // High res for print
                stripHeight: 1800, // 4x6 Ratio (2:3)
                apiKey: 'ffc90ad0bc5c7e0c056b68ef7430304a'
            };

            let state = {
                stream: null,
                photos: [],
                filter: 'normal',
                timer: 3,
                processing: false,
                frameImg: null,
                facingMode: 'user'
            };

            const DOM = {
                screens: {
                    home: document.getElementById('screen-home'),
                    cam: document.getElementById('screen-cam'),
                    result: document.getElementById('screen-result')
                },
                video: document.getElementById('video-feed'),
                canvas: document.getElementById('hidden-canvas'),
                count: document.getElementById('countdown-display'),
                flash: document.getElementById('flash-overlay'),
                final: document.getElementById('final-img'),
                print: document.getElementById('print-only-img'),
                counter: document.getElementById('shot-counter')
            };

            // Audio Context for Better Sounds
            const AudioEngine = {
                ctx: null,
                init: function() {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                },
                beep: function() {
                    if(!this.ctx) this.init();
                    if(this.ctx.state === 'suspended') this.ctx.resume();
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.connect(g); g.connect(this.ctx.destination);
                    o.frequency.value = 880; g.gain.value = 0.1;
                    o.start(); g.gain.exponentialRampToValueAtTime(0.00001, this.ctx.currentTime + 0.1);
                    o.stop(this.ctx.currentTime + 0.1);
                },
                shutter: function() {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏±‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á (Mirror Slap sound)
                    if(!this.ctx) this.init();
                    const t = this.ctx.currentTime;
                    
                    // High Click
                    const o1 = this.ctx.createOscillator();
                    const g1 = this.ctx.createGain();
                    o1.connect(g1); g1.connect(this.ctx.destination);
                    o1.type = 'triangle';
                    o1.frequency.setValueAtTime(1200, t);
                    o1.frequency.exponentialRampToValueAtTime(100, t + 0.1);
                    g1.gain.setValueAtTime(0.3, t);
                    g1.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                    o1.start(t); o1.stop(t + 0.1);

                    // Low Thud (Mirror return)
                    const o2 = this.ctx.createOscillator();
                    const g2 = this.ctx.createGain();
                    o2.connect(g2); g2.connect(this.ctx.destination);
                    o2.type = 'sine';
                    o2.frequency.setValueAtTime(150, t + 0.05);
                    g2.gain.setValueAtTime(0.5, t + 0.05);
                    g2.gain.exponentialRampToValueAtTime(0.01, t + 0.25);
                    o2.start(t + 0.05); o2.stop(t + 0.25);
                }
            };

            // Load Frame
            const frame = new Image();
            frame.src = 'frame.png'; // Make sure this is transparent PNG
            frame.onload = () => state.frameImg = frame;

            function switchScreen(name) {
                Object.values(DOM.screens).forEach(s => s.classList.remove('active'));
                DOM.screens[name].classList.add('active');
            }

            async function start() {
                AudioEngine.init();
                await initCamera();
                state.photos = [];
                updateCounter();
                switchScreen('cam');
            }

            async function initCamera() {
                if(state.stream) state.stream.getTracks().forEach(t=>t.stop());
                try {
                    state.stream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: state.facingMode, width: {ideal: 1920}, height: {ideal: 1080} },
                        audio: false
                    });
                    DOM.video.srcObject = state.stream;
                } catch(e) { alert("Camera Access Denied"); }
            }

            function toggleCam() {
                state.facingMode = state.facingMode === 'user' ? 'environment' : 'user';
                initCamera();
            }

            function toggleTimer() {
                state.timer = state.timer === 3 ? 5 : (state.timer === 5 ? 10 : 3);
                document.getElementById('btn-timer').innerText = `‚è± ${state.timer}s`;
            }

            function filter(mode, el) {
                state.filter = mode;
                document.querySelectorAll('.filter-dot').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
                
                // CSS Filter for Preview
                let css = 'none';
                if(mode==='beauty') css = 'saturate(1.1) brightness(1.1) contrast(1.05)';
                if(mode==='bw') css = 'grayscale(100%) contrast(1.2)';
                if(mode==='film') css = 'sepia(0.3) contrast(1.1) saturate(0.8)';
                DOM.video.style.filter = css;
            }

            async function snap() {
                if(state.processing) return;
                state.processing = true;

                for(let i=0; i<CONFIG.shots; i++) {
                    updateCounter(i+1);
                    await runCountdown(state.timer);
                    AudioEngine.shutter();
                    flashEffect();
                    await capturePhoto();
                    await new Promise(r => setTimeout(r, 1000)); // Delay between shots
                }

                finishSession();
            }

            function updateCounter(current = 1) {
                DOM.counter.innerText = `${current} / ${CONFIG.shots}`;
            }

            function runCountdown(sec) {
                return new Promise(resolve => {
                    let c = sec;
                    DOM.count.style.opacity = 1;
                    DOM.count.innerText = c;
                    AudioEngine.beep();
                    
                    const int = setInterval(() => {
                        c--;
                        if(c > 0) {
                            DOM.count.innerText = c;
                            AudioEngine.beep();
                        } else {
                            clearInterval(int);
                            DOM.count.style.opacity = 0;
                            resolve();
                        }
                    }, 1000);
                });
            }

            function flashEffect() {
                DOM.flash.style.opacity = 1;
                setTimeout(() => DOM.flash.style.opacity = 0, 150);
            }

            function capturePhoto() {
                return new Promise(resolve => {
                    const canvas = document.createElement('canvas');
                    canvas.width = DOM.video.videoWidth;
                    canvas.height = DOM.video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    
                    // Flip if user mode
                    if(state.facingMode === 'user') {
                        ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
                    }
                    
                    ctx.filter = DOM.video.style.filter; // Apply filter
                    ctx.drawImage(DOM.video, 0, 0);
                    
                    state.photos.push(canvas);
                    resolve();
                });
            }

            function finishSession() {
                state.processing = false;
                generateStrip();
                switchScreen('result');
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#D4AF37', '#fff'] });
                uploadImage();
            }

            function generateStrip() {
                const W = CONFIG.stripWidth;
                const H = CONFIG.stripHeight;
                DOM.canvas.width = W;
                DOM.canvas.height = H;
                const ctx = DOM.canvas.getContext('2d');

                // 1. White Background (Photo Paper)
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, W, H);

                // 2. Layout Calculation
                // Design: Top Logo Area, 3 Photos stacked, Bottom Text
                const marginX = 80;
                const photoW = W - (marginX * 2);
                const photoH = (photoW * 3) / 4; // 4:3 Aspect Ratio
                const gap = 40;
                const startY = 300; // Space for Header

                // Header Text (Fallback if no frame)
                if(!state.frameImg) {
                    ctx.fillStyle = "#000";
                    ctx.font = "bold 60px 'Playfair Display'";
                    ctx.textAlign = "center";
                    ctx.fillText("SENA MEMORIES", W/2, 150);
                    ctx.font = "30px 'Prompt'";
                    ctx.fillText("Class of 2024", W/2, 220);
                }

                // Draw Photos
                state.photos.forEach((p, index) => {
                    const y = startY + (index * (photoH + gap));
                    
                    // Crop center of video to 4:3
                    const sW = p.height * (4/3);
                    const sX = (p.width - sW) / 2;
                    
                    ctx.drawImage(p, sX, 0, sW, p.height, marginX, y, photoW, photoH);
                });

                // 3. Overlay Frame (PNG)
                if(state.frameImg) {
                    ctx.drawImage(state.frameImg, 0, 0, W, H);
                }

                // Set Result Image
                DOM.final.src = DOM.canvas.toDataURL('image/jpeg', 1.0);
            }

            function printPhoto() {
                // Prepare print image
                DOM.print.src = DOM.final.src;
                
                // Small delay to ensure image render before print dialog
                setTimeout(() => {
                    window.print();
                }, 500);
            }

            async function uploadImage() {
                // Upload logic for QR Code
                if(!CONFIG.apiKey) return;
                try {
                    const blob = await new Promise(r => DOM.canvas.toBlob(r, 'image/jpeg', 0.9));
                    const fd = new FormData();
                    fd.append('image', blob);
                    
                    // Show Loading or similar logic here if needed
                    const res = await fetch(`https://api.imgbb.com/1/upload?key=${CONFIG.apiKey}`, { method:'POST', body:fd });
                    const data = await res.json();
                    
                    if(data.success) {
                        const qrBox = document.getElementById('qrcode');
                        qrBox.innerHTML = '';
                        new QRCode(qrBox, { text: data.data.url, width: 100, height: 100 });
                        document.getElementById('qr-area').style.display = 'block';
                    }
                } catch(e) { console.error("Upload failed"); }
            }

            function download() {
                const a = document.createElement('a');
                a.href = DOM.final.src;
                a.download = 'SENA_Photo.jpg';
                a.click();
            }

            function restart() {
                location.reload();
            }

            return { start, toggleCam, toggleTimer, filter, snap, printPhoto, download, restart };
        })();
    </script>
</body>
</html>
